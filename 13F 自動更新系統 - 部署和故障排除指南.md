# 13F 自動更新系統 - 部署和故障排除指南

## 🔴 問題總結

您遇到的自動更新系統有兩個主要錯誤：

### 錯誤 1: SEC API 403 Forbidden
```
Error: 403 Client Error: Forbidden for url: https://www.sec.gov/cgi-bin/browse-edgar...
```

**原因：**
- SEC 服務器拒絕了請求
- User-Agent 不正確或被識別為機器人
- 請求速率過快

**解決方案：**
- ✅ 使用正確的 User-Agent
- ✅ 添加請求延遲（500ms）
- ✅ 改進的錯誤處理

### 錯誤 2: Python 類型提示
```
NameError: name 'Dict' is not defined. Did you mean: 'dict'?
```

**原因：**
- 缺少 `from typing import Dict` 導入

**解決方案：**
- ✅ 已添加正確的類型提示導入
- ✅ 改進的類型註解

---

## ✅ 修復方案

### 新增功能：

1. **靜態數據備份**
   - 當 SEC API 失敗時，使用預設的靜態數據
   - 確保網站始終有數據顯示
   - 不會因為 API 問題而出現空白

2. **改進的錯誤處理**
   - `continue-on-error: true` - 允許工作流繼續
   - 更好的日誌記錄
   - 自動生成執行摘要

3. **請求延遲**
   - 500ms 延遲避免被限制
   - 正確的 User-Agent
   - 更長的超時時間（15 秒）

---

## 🚀 部署步驟

### 步驟 1: 更新 GitHub 倉庫

```bash
# 進入倉庫目錄
cd your-repo

# 複製修復後的腳本
cp fetch-13f-data-fixed.py scripts/fetch-13f-data.py
cp update-html-data-fixed.py scripts/update-html-data.py

# 複製修復後的工作流
mkdir -p .github/workflows
cp update-13f-data-fixed.yml .github/workflows/update-13f-data.yml

# 提交更改
git add scripts/fetch-13f-data.py
git add scripts/update-html-data.py
git add .github/workflows/update-13f-data.yml
git commit -m "fix: Improve 13F data fetching with error handling and fallback data"
git push origin main
```

### 步驟 2: 驗證部署

1. 進入 GitHub 倉庫
2. 點擊 **Actions** 標籤
3. 找到 "Automatic 13F Data Update" 工作流
4. 點擊 **Run workflow** 手動測試
5. 等待執行完成（通常 1-2 分鐘）

### 步驟 3: 檢查結果

✅ **成功標誌：**
- 工作流顯示綠色勾號
- 執行摘要顯示 "13F Data Update Successful"
- 網站數據已更新

⚠️ **部分成功標誌：**
- 工作流顯示黃色警告
- 執行摘要顯示 "Using fallback data"
- 網站仍然可以顯示數據（使用緩存）

---

## 📊 修復後的工作流程

```
GitHub Actions 觸發
    ↓
檢出代碼
    ↓
安裝 Python 依賴
    ↓
嘗試從 SEC EDGAR 抓取數據
    ├─ 成功 → 保存到 JSON
    └─ 失敗 → 使用靜態備份數據
    ↓
更新 HTML 文件
    ├─ 成功 → 更新所有數據
    └─ 失敗 → 保留原有數據
    ↓
檢查是否有變化
    ├─ 有變化 → 提交並推送
    └─ 無變化 → 跳過提交
    ↓
生成執行摘要
    ├─ 成功 → 顯示成功消息
    └─ 失敗 → 顯示備份數據消息
```

---

## 🔧 故障排除

### 問題 1: 工作流仍然失敗

**檢查清單：**
1. ✅ 確認 Python 腳本已正確上傳到 `scripts/` 目錄
2. ✅ 確認工作流文件在 `.github/workflows/` 目錄
3. ✅ 檢查 GitHub Actions 日誌查看具體錯誤
4. ✅ 確認 `dist/` 目錄存在

**解決方案：**
```bash
# 手動測試 Python 腳本
python3 scripts/fetch-13f-data.py
python3 scripts/update-html-data.py

# 檢查生成的文件
ls -la scripts/13f-data.json
```

### 問題 2: 網站數據仍為空

**原因：**
- HTML 文件中的數據標籤不匹配
- 正則表達式模式不正確

**解決方案：**
1. 檢查 HTML 文件中的數據格式
2. 更新 Python 腳本中的正則表達式
3. 手動更新 HTML 文件中的數據

### 問題 3: 工作流執行但沒有提交

**原因：**
- 沒有檢測到文件變化
- 或者 HTML 文件不存在

**解決方案：**
```bash
# 確認文件存在
ls -la dist/index.html
ls -la dist/multi-fund-comparison.html

# 手動運行更新腳本
python3 scripts/update-html-data.py

# 檢查是否有變化
git status
```

---

## 📝 文件清單

| 文件 | 位置 | 用途 |
|-----|------|------|
| `fetch-13f-data.py` | `scripts/` | 從 SEC EDGAR 抓取數據 |
| `update-html-data.py` | `scripts/` | 更新 HTML 文件 |
| `update-13f-data.yml` | `.github/workflows/` | GitHub Actions 工作流 |
| `13f-data.json` | `scripts/` | 緩存的 13F 數據 |

---

## 🎯 最佳實踐

### 1. 定期檢查工作流
- 每月檢查 15 日和 30 日的執行結果
- 查看執行摘要確認成功
- 驗證網站數據已更新

### 2. 監控 SEC API 變化
- SEC 可能會更改 API 端點
- 定期檢查 SEC EDGAR 文檔
- 準備備用方案

### 3. 數據驗證
- 定期檢查網站上的數據
- 與 SEC EDGAR 官方數據對比
- 確保準確性

### 4. 備份策略
- 保留歷史數據備份
- 定期導出數據為 CSV
- 保存重要的 13F 報告

---

## 📞 技術支持

### 常見問題

**Q: 為什麼 SEC API 返回 403 錯誤？**
A: SEC 服務器可能將您的請求識別為機器人。使用正確的 User-Agent 和請求延遲可以解決。

**Q: 如果 API 失敗，網站會發生什麼？**
A: 網站將使用靜態備份數據，確保始終有數據顯示。

**Q: 多久更新一次數據？**
A: 每月 15 日和 30 日自動檢查。SEC 通常在季度結束後 45 天內發布新的 13F。

**Q: 我可以手動觸發更新嗎？**
A: 可以。進入 GitHub Actions，點擊工作流，然後點擊 "Run workflow"。

---

## ✨ 下一步

1. ✅ 部署修復後的腳本
2. ✅ 手動測試工作流
3. ✅ 驗證網站數據正確
4. ✅ 監控自動更新執行
5. ✅ 根據需要進行調整

---

**系統現在已經更加穩定和可靠！** 🎉

